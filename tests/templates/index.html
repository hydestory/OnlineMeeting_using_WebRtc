<!DOCTYPE html>
<html>
<head>
  <title>Online Users</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <style>
    .container {
      margin-top: 50px;
    }
  </style>
  <script src="https://cdn.socket.io/4.1.2/socket.io.js"></script>
  <script>
    var socket = io.connect('http://127.0.0.1:5000');

    // 監聽從伺服器端接收的消息
    socket.on('message', function(data) {
          var messageElement = document.createElement('li');
          messageElement.textContent = data;
          document.getElementById('messages').appendChild(messageElement);
        });

    // 發送消息到伺服器端
    function sendMessage() {
        var chatmessage = document.getElementById('message').value;
        socket.emit('message', chatmessage);
        document.getElementById('message').value = '';
        }

  </script>
</head>
<body>
  <div class="container">
    <h1>Online Users</h1>
    <ul id="userList" class="list-group">
      {% for user in online_users %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <span>{{ user }}</span>
            <button id="{{ user }}-btn" class="btn btn-primary btn-sm" onclick="showConfirmation('{{ user }}')">Connect</button>
          </div>
        </li>
      {% endfor %}
    </ul>
  </div>

  <ul id="messages">hi</ul>
    <input type="text" id="message" placeholder="輸入消息">
    <button onclick="sendMessage()">發送</button>

  <!-- Bootstrap Modal -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmationModalLabel">確認連線</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>確定要和 <span id="userToConnect"></span> 建立連線嗎？</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="connect-button" onclick="connect()">確定</button>
        </div>
      </div>
    </div>
  </div>
  

   <!-- refresh botton -->
  <div class="container">
    <div class="d-flex justify-content-end mb-3">
      <button id="refreshUserButton" class="btn btn-secondary" onclick="refreshUserList()">Refresh User</button>
    </div>
  </div>
  




  <script>
    var userToConnect = "";
    
    function showConfirmation(user) {
      userToConnect = user;
      document.getElementById('userToConnect').textContent = user;
      var confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
      confirmationModal.show();
    }
    
    function connect() {
      console.log("Connect clicked for user:", userToConnect);
      var connectButton = document.getElementById(userToConnect + '-btn');
      connectButton.textContent = 'Connecting...';
      connectButton.disabled = true; // disable the button

      // 這裡可以進行相應的建立連線操作

      var confirmationModal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
      confirmationModal.hide();
    }


    // refresh botton的設定

    function refreshUserList() {
      fetch('/api/online_users')  // Replace with your actual API endpoint
        .then(response => response.json())
        .then(data => {
          const userList = document.getElementById('userList');
          userList.innerHTML = '';  // Clear the existing list
          
          data.forEach(user => {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';
            
            const userDiv = document.createElement('div');
            userDiv.className = 'd-flex justify-content-between align-items-center';

            const usernameSpan = document.createElement('span');
            usernameSpan.textContent = user;

            const connectButton = document.createElement('button');
            connectButton.id = user + '-btn';
            connectButton.className = 'btn btn-primary btn-sm';
            connectButton.textContent = 'Connect';
            connectButton.onclick = function() { showConfirmation(user); };

            userDiv.appendChild(usernameSpan);
            userDiv.appendChild(connectButton);
            listItem.appendChild(userDiv);
            userList.appendChild(listItem);
          });
        });
    }



//以下是不確定的部分
    const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    var pc = new RTCPeerConnection();
    
   

    socket.on('sdp', function(message) {
        console.log("Received an SDP from the server.the message is:"+message['sdp']);
        var desc = new RTCSessionDescription(message['sdp']);
        pc.setRemoteDescription(desc).then(function () {
            if (desc.type == 'offer') {
                console.log("SDP is an offer. Creating an answer.");
                pc.createAnswer().then(answer => {
                    return pc.setLocalDescription(answer);
                }).then(function() {
                    console.log("Answer created and set as local description. Sending it to the server.");
                    socket.emit('sdp', { 'sdp': pc.localDescription });
                }).catch(error => console.error("Error: ", error));
            }
        }).catch(error => console.error("Error: ", error));
    });

    socket.on('ice_candidate', function(message) {
        console.log("Received an Ice Candidate from the server.");
        if (message['candidate']) {
            pc.addIceCandidate(new RTCIceCandidate(message['candidate'])).catch(error => console.error("Error: ", error));
        }
    });

    window.addEventListener('load', function() {
        console.log("Page loaded. Creating an offer.");
        pc.createOffer().then(offer => {
            return pc.setLocalDescription(offer);
        }).then(function() {
            console.log("Offer created and set as local description. Sending it to the server.");
            socket.emit('sdp', { 'sdp': pc.localDescription });
        }).catch(error => console.error("Error: ", error));
    });


    pc.onicecandidate = function(event) {
        if (event.candidate) {
            console.log("OnIceCandidate event triggered. Sending Ice Candidate to the server.");
            socket.emit('ice_candidate', {'candidate': event.candidate});
        }
    };

    pc.onconnectionstatechange = function(event) {
        console.log("Connection state changed: ", pc.connectionState);
        if (pc.connectionState === 'connected') {
            console.log("PeerConnection connected. Sending 'hello' message.");
            pc.createDataChannel('chat').onopen = function(event) {
                this.send('hello');
            };
        }
    };

    pc.ondatachannel = function(event) {
        console.log("DataChannel event: ", event);
        var dataChannel = event.channel;
        dataChannel.onmessage = function(event) {
            console.log("Received message:", event.data);
        };
        dataChannel.onopen = function() {
            console.log("Data channel is open");
        };
        dataChannel.onclose = function() {
            console.log("Data channel is closed");
        };
    };



  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
</body>
</html>
